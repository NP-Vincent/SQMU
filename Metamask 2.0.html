<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Crypto Payment</title>
</head>
<body>
  <div id="widget">
  <h3 id="prop-title"></h3>
  <p id="price-aed"></p>
  <p id="price-usd"></p>
  <p id="mobile-tip" style="display:none;">For best results open this page from your wallet's built-in browser (preferably MetaMask). Other wallet browsers may refresh and lose form data.</p>
  <select id="network-select"></select>
  <button id="connect-btn" class="wp-block-button__link">Connect Wallet</button>
  <button id="disconnect-btn" class="wp-block-button__link" style="display:none;">Disconnect</button>
  <label for="email-input">Email<span>*</span></label>
  <input id="email-input" type="email" placeholder="Email for receipt" required>
  <button id="pay-btn" class="wp-block-button__link" disabled>Pay</button>
  <div id="qr"></div>
  <pre id="msg"></pre>
  <div id="post-pay" style="display:none;">
    <button id="schedule-btn" class="wp-block-button__link">Schedule Call</button>
    <pre id="tx-details"></pre>
    <button id="copy-btn" class="wp-block-button__link">Copy Details</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1/dist/umd/index.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    const MAIL_URL = 'https://script.google.com/macros/s/AKfycbxW9QUOwDLGPrG2C5aHZDQLyDJKobJUurOWSbd9Y2C4sbapNTd0jGfFh8sFAl2qgbRQvQ/exec'; // Google Apps Script endpoint
    // === CONFIGURATION ===
    const PAYMENT_OPTIONS = [
      { token: 'USDT', name: 'Ethereum', chainId: 1, rpc: 'https://rpc.ankr.com/eth', address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', decimals: 6 },
      { token: 'USDC', name: 'Arbitrum', chainId: 42161, rpc: 'https://arb1.arbitrum.io/rpc', address: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831', decimals: 6 },
      { token: 'USDC', name: 'Polygon', chainId: 137, rpc: 'https://polygon-rpc.com', address: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359', decimals: 6 }
    ];

    const EXPLORERS = {
      1: 'https://etherscan.io',
      42161: 'https://arbiscan.io',
      137: 'https://polygonscan.com'
    };

    const DEST = '0x43F3f03d89290358034993aE3B3938D056D76De2';

    const CHAIN_INFO = {
      1: {
        chainName: 'Ethereum',
        rpcUrls: ['https://rpc.ankr.com/eth'],
        nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
        blockExplorerUrls: ['https://etherscan.io']
      },
      137: {
        chainName: 'Polygon',
        rpcUrls: ['https://polygon-rpc.com'],
        nativeCurrency: { name: 'Matic', symbol: 'MATIC', decimals: 18 },
        blockExplorerUrls: ['https://polygonscan.com']
      },
      42161: {
        chainName: 'Arbitrum One',
        rpcUrls: ['https://arb1.arbitrum.io/rpc'],
        nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
        blockExplorerUrls: ['https://arbiscan.io']
      }
    };

    // === STATE ===
    let provider = null;
    let signer = null;
    let currentWallet = null; // 'metamask' or 'walletconnect'

    // === UI UTILS ===
    function show(msg) {
      document.getElementById('msg').textContent = msg;
    }

    function enablePayBtn(enabled) {
      const emailOk = document.getElementById('email-input').validity.valid;
      document.getElementById('pay-btn').disabled = !(enabled && emailOk);
    }

    function showReceiptForm(payLink, amount, option, email) {
      const msg = document.getElementById('msg');
      msg.innerHTML = '';
      const h3 = document.createElement('h3');
      h3.textContent = 'Get Email Receipt';
      const form = document.createElement('form');
      form.id = 'receipt-form';
      form.action = MAIL_URL;
      form.method = 'POST';
      form.target = '_blank';

      const emailInput = document.createElement('input');
      emailInput.type = 'email';
      emailInput.name = 'to_email';
      emailInput.value = email;
      emailInput.placeholder = 'Email';
      emailInput.required = true;
      form.appendChild(emailInput);
      form.appendChild(document.createElement('br'));

      const hiddenFields = {
        tx_link: payLink,
        usd: amount,
        chain: option.name,
        token: option.token
      };
      for (const [name, value] of Object.entries(hiddenFields)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        form.appendChild(input);
      }

      const btn = document.createElement('button');
      btn.type = 'submit';
      btn.className = 'wp-block-button__link';
      btn.textContent = 'Send Receipt';
      form.appendChild(btn);

      msg.appendChild(h3);
      msg.appendChild(form);
      const info = document.createElement('div');
      const em = document.createElement('em');
      em.textContent = 'A new tab will open. Please check your inbox after a few moments.';
      info.appendChild(em);
      msg.appendChild(info);
    }

    // === WALLET CONNECTION LOGIC ===
    async function setupWallet(kind) {
      if (kind === 'metamask' && window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = await provider.getSigner();
        currentWallet = 'metamask';
        return;
      }
      if (kind === 'walletconnect') {
        const wc = new window.WalletConnectProvider.default({
          rpc: Object.fromEntries(PAYMENT_OPTIONS.map(o => [o.chainId, o.rpc]))
        });
        await wc.enable();
        provider = new ethers.BrowserProvider(wc);
        signer = await provider.getSigner();
        currentWallet = 'walletconnect';
        return;
      }
      throw new Error('No wallet found');
    }

    function disconnectWallet() {
      if (currentWallet === 'walletconnect' && provider?.provider?.disconnect) {
        provider.provider.disconnect();
      }
      provider = null;
      signer = null;
      currentWallet = null;
      enablePayBtn(false);
      document.getElementById('disconnect-btn').style.display = 'none';
      show('Wallet disconnected');
    }

    // === NETWORK SWITCHING ===
    async function switchNetwork(token) {
      if (currentWallet === 'metamask' && window.ethereum) {
        const hex = ethers.toQuantity(token.chainId);
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: hex }]
          });
        } catch (err) {
          if (err.code === 4902) {
            // Not added yet, try to add
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{ chainId: hex, ...CHAIN_INFO[token.chainId] }]
            });
            // Then switch
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: hex }]
            });
          } else {
            throw err;
          }
        }
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        return;
      }

      if (currentWallet === 'walletconnect') {
        // WalletConnect handles network switching internally; make sure to refresh provider & signer
        provider = new ethers.BrowserProvider(provider.provider);
        signer = await provider.getSigner();
        return;
      }

      throw new Error('No wallet/provider to switch network');
    }

    async function ensureCorrectNetwork(token) {
      if (!provider) throw new Error('No wallet/provider connected');
      const network = await provider.getNetwork();
      if (Number(network.chainId) !== Number(token.chainId)) {
        throw new Error(`Your wallet is on the wrong network. Please switch to ${token.name} (${token.chainId})`);
      }
    }

    // === ERC-20 PAYMENT LOGIC ===
    function getErc20(token) {
      const abi = [
        'function balanceOf(address) view returns (uint256)',
        'function transfer(address,uint256) returns (bool)'
      ];
      return new ethers.Contract(token.address, abi, signer);
    }

    async function sendToken(token, to, amt) {
      await ensureCorrectNetwork(token);
      const erc20 = getErc20(token);
      const data = erc20.interface.encodeFunctionData(
        'transfer',
        [to, ethers.parseUnits(String(amt), token.decimals)]
      );
      const tx = await signer.sendTransaction({
        to: token.address,
        data,
        gasLimit: 70000
      });
      return tx.wait();
    }


    // === MAIN UI HANDLING ===
    document.addEventListener('DOMContentLoaded', async () => {
      const postPay = document.getElementById('post-pay');
      const txDetails = document.getElementById('tx-details');
      const emailInput = document.getElementById('email-input');
      const mobileTip = document.getElementById('mobile-tip');
      const ua = navigator.userAgent || navigator.vendor || '';
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      if (isMobile) mobileTip.style.display = '';
      emailInput.oninput = () => enablePayBtn(!!(provider && signer));
      function copyDetails() {
        const text = txDetails.textContent || document.getElementById('msg').textContent;
        navigator.clipboard.writeText(text);
      }
      document.getElementById('copy-btn').onclick = copyDetails;
      document.getElementById('schedule-btn').onclick = () => {
        window.open('https://calendly.com/sqmu-call', '_blank');
      };
      // Setup UI with params
      let search = location.search;
      if (!search && location.hash.includes('?')) {
        search = location.hash.substring(location.hash.indexOf('?'));
      }
      const params = new URLSearchParams(search);
      const usdVal = params.get('usd');
      let aedVal = params.get('aed');
      if (!aedVal && usdVal) {
        aedVal = (parseFloat(usdVal) * 3.67).toFixed(2);
      }
      document.getElementById('prop-title').textContent = params.get('title') || '';
      document.getElementById('price-aed').textContent = aedVal ? `AED ${aedVal}` : '';
      document.getElementById('price-usd').textContent = usdVal ? `USD ${usdVal}` : '';

      const buyToken = params.get('buy');
      const buyChain = Number(params.get('buyChain'));
      window.BUY_TOKEN = buyToken;
      window.BUY_CHAIN = buyChain;

      // Populate network selector
      const select = document.getElementById('network-select');
      PAYMENT_OPTIONS.forEach((o, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${o.token} (${o.name})`;
        select.appendChild(opt);
      });

      // Preselect network based on ?token= and ?chain=
      let idx = -1;
      const tokenParam = params.get('token');
      const chainParam = params.get('chain');
      if (tokenParam && chainParam) {
        idx = PAYMENT_OPTIONS.findIndex(o =>
          o.token.toLowerCase() === tokenParam.toLowerCase() &&
          String(o.chainId) === chainParam
        );
      }
      if (idx === -1 && chainParam) {
        idx = PAYMENT_OPTIONS.findIndex(o => String(o.chainId) === chainParam);
      }
      if (idx === -1 && tokenParam) {
        idx = PAYMENT_OPTIONS.findIndex(o => o.token.toLowerCase() === tokenParam.toLowerCase());
      }
      if (idx >= 0) {
        select.value = String(idx);
      }

      // Setup QR code for manual payment
      new QRCode(document.getElementById('qr'), DEST);

      // Connect Wallet
      document.getElementById('connect-btn').onclick = async () => {
        enablePayBtn(false);
        show('Connecting...');
        try {
          // Connect wallet (MetaMask only here, could add WalletConnect as a dropdown/option)
          await setupWallet('metamask');
          const option = PAYMENT_OPTIONS[select.value];
          // Switch to selected network after connection
          await switchNetwork(option);
          await ensureCorrectNetwork(option);
          document.getElementById('disconnect-btn').style.display = '';
          document.getElementById('disconnect-btn').onclick = disconnectWallet;
          show('Wallet connected to ' + option.name);
          enablePayBtn(true);
        } catch (err) {
          show('Connection or network switch failed:\n' + (err.message || err));
          disconnectWallet();
        }
      };

      // Pay
      document.getElementById('pay-btn').onclick = async () => {
        enablePayBtn(false);
        const option = PAYMENT_OPTIONS[select.value];
        const amount = Number(params.get('usd'));
        if (!Number.isFinite(amount) || amount <= 0) {
          show('Invalid USD amount');
          return;
        }
        try {
          show('Checking network...');
          await switchNetwork(option);
          await ensureCorrectNetwork(option);
          const network = await provider.getNetwork();
          show(`Sending ${amount} ${option.token} to ${DEST} on chain ${network.chainId}...`);
          const receipt = await sendToken(option, DEST, amount);
          const payLink = `${EXPLORERS[option.chainId]}/tx/${receipt.hash}`;
          show(`âœ… Sent ${amount} ${option.token} to ${DEST} on ${option.name}\n\nView transaction: ${payLink}`);
          txDetails.textContent = `Payment: ${payLink}`;
          postPay.style.display = '';
          showReceiptForm(payLink, amount, option, emailInput.value);
        } catch (err) {
          show('Payment failed:\n' + (err.message || err));
        }
        enablePayBtn(true);
      };

      // Network select: on change, try to switch wallet network if already connected
      select.onchange = async () => {
        if (provider && signer && currentWallet) {
          const option = PAYMENT_OPTIONS[select.value];
          try {
            await switchNetwork(option);
            await ensureCorrectNetwork(option);
            show(`Switched to ${option.name}`);
            enablePayBtn(true);
          } catch (err) {
            show('Network switch failed:\n' + (err.message || err));
            enablePayBtn(false);
          }
        }
      };

      // Disconnect
      document.getElementById('disconnect-btn').onclick = disconnectWallet;
    });
  </script>
  </div>
</body>
</html>
