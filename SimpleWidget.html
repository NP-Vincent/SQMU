<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Crypto Payment</title>
  <style>

    body { font-family: sans-serif; margin: auto; }
    #msg { white-space: pre-wrap; }
  </style>
</head>
<body>
  <h3 id="prop-title"></h3>
  <p id="price-aed"></p>
  <p id="price-usd"></p>
  <button id="connect-btn">Connect Wallet</button>
  <button id="disconnect-btn" style="display:none;">Disconnect</button>
  <select id="network-select"></select>
  <button id="pay-btn" disabled>Pay</button>
  <div id="qr"></div>
  <pre id="msg"></pre>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1/dist/umd/index.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    const PAYMENT_OPTIONS = [
      { token: 'USDT', name: 'Ethereum', chainId: 1, rpc: 'https://rpc.ankr.com/eth', address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', decimals: 6 },
      { token: 'USDC', name: 'Arbitrum', chainId: 42161, rpc: 'https://arb1.arbitrum.io/rpc', address: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831', decimals: 6 },
      { token: 'USDC', name: 'Polygon', chainId: 137, rpc: 'https://polygon-rpc.com', address: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359', decimals: 6 }
    ]

    const EXPLORERS = {
      1: 'https://etherscan.io',
      42161: 'https://arbiscan.io',
      137: 'https://polygonscan.com'
    }

    const DEST = '0x43F3f03d89290358034993aE3B3938D056D76De2'

    const CHAIN_INFO = {
      1: {
        chainName: 'Ethereum',
        rpcUrls: ['https://rpc.ankr.com/eth'],
        nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
        blockExplorerUrls: ['https://etherscan.io']
      },
      137: {
        chainName: 'Polygon',
        rpcUrls: ['https://polygon-rpc.com'],
        nativeCurrency: { name: 'Matic', symbol: 'MATIC', decimals: 18 },
        blockExplorerUrls: ['https://polygonscan.com']
      },
      42161: {
        chainName: 'Arbitrum One',
        rpcUrls: ['https://arb1.arbitrum.io/rpc'],
        nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
        blockExplorerUrls: ['https://arbiscan.io']
      }
    }

    let provider
    let signer

    async function ensureCorrectNetwork(token) {
      const net = await provider.getNetwork()
      if (net.chainId !== token.chainId) {
        show(`Please switch your wallet network to ${token.name} and try again.`)
        throw new Error('Wrong network')
      }
    }

    function setupWallet(kind) {
      if (kind === 'metamask' && window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum)
        return provider.send('eth_requestAccounts', [])
      }
      if (kind === 'walletconnect') {
        const wc = new window.WalletConnectProvider.default({
          rpc: Object.fromEntries(PAYMENT_OPTIONS.map(o => [o.chainId, o.rpc]))
        })
        provider = new ethers.BrowserProvider(wc)
        return wc.enable()
      }
      return Promise.reject('No wallet found')
    }

    function getErc20(token) {
      const abi = ['function balanceOf(address) view returns (uint256)', 'function transfer(address,uint256) returns (bool)']
      return new ethers.Contract(token.address, abi, signer)
    }

    async function ensureBalance(token, addr, amt) {
      const erc20 = getErc20(token)
      const bal = await erc20.balanceOf(addr)
      return Number(ethers.formatUnits(bal, token.decimals)) >= amt
    }

    async function sendToken(token, to, amt) {
      const erc20 = getErc20(token)
      const tx = await erc20.transfer(to, ethers.parseUnits(String(amt), token.decimals))
      return tx.wait()
    }

    async function switchNetwork(token) {
        if (!provider?.provider?.request) return false
        const hex = ethers.toBeHex(token.chainId)
        try {
          await provider.provider.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: hex }]
          })
        } catch (err) {
          if (err.code === 4902) {
            try {
              await provider.provider.request({
                method: 'wallet_addEthereumChain',
                params: [{ chainId: hex, ...CHAIN_INFO[token.chainId] }]
              })
              await provider.provider.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: hex }]
              })
            } catch (_) {
              show('Network switch failed')
              return false
            }
          } else {
            show('Network switch failed')
            return false
          }
        }
        provider = new ethers.BrowserProvider(provider.provider)
        signer = await provider.getSigner()
        return true
      }

    function disconnectWallet() {
      if (provider?.provider?.disconnect) {
        provider.provider.disconnect()
        show('Wallet disconnected')
      } else {
        show('Widget reset. Disconnect MetaMask from the extension.')
      }
      provider = null
      signer = null
      document.getElementById('pay-btn').disabled = true
      document.getElementById('disconnect-btn').style.display = 'none'
    }
    function show(msg) {
      document.getElementById('msg').textContent = msg
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(location.search)
      document.getElementById('prop-title').textContent = params.get('title') || ''
      document.getElementById('price-aed').textContent = params.get('aed') ? `AED ${params.get('aed')}` : ''
      document.getElementById('price-usd').textContent = params.get('usd') ? `USD ${params.get('usd')}` : ''

      const select = document.getElementById('network-select')
      PAYMENT_OPTIONS.forEach((o, i) => {
        const opt = document.createElement('option')
        opt.value = i
        opt.textContent = `${o.token} (${o.name})`
        select.appendChild(opt)
      })

      new QRCode(document.getElementById('qr'), DEST)

      document.getElementById('connect-btn').onclick = async () => {
        try {
          await setupWallet('metamask')
          const option = PAYMENT_OPTIONS[select.value]
          await switchNetwork(option)
          signer = await provider.getSigner()
          const net = await provider.getNetwork()
          document.getElementById('pay-btn').disabled = false
          document.getElementById('disconnect-btn').style.display = ''
          document.getElementById('disconnect-btn').onclick = disconnectWallet
          show(`Wallet connected to chain ${net.chainId}`)
        } catch (err) {
          show('Connection or network switch failed: ' + (err.message || err))
        }
      }

      document.getElementById('pay-btn').onclick = async () => {
        const option = PAYMENT_OPTIONS[select.value]
        const amount = Number(params.get('usd'))
        const dest = DEST
        try {
          await switchNetwork(option)
          await ensureCorrectNetwork(option)
          const net = await provider.getNetwork()
          show(`Connected to chain: ${net.chainId} for payment of ${amount} ${option.token}`)
          const receipt = await sendToken(option, dest, amount)
          const link = `${EXPLORERS[option.chainId]}/tx/${receipt.transactionHash}`
          show(`Sent ${amount} ${option.token} to ${dest} on ${option.name}\n${link}`)
        } catch (err) {
          show('Payment failed: ' + (err.message || err))
          console.error(err)
        }
      }
    })
  </script>
</body>
</html>
