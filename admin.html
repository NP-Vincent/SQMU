<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SQMU Admin</title>
  <style>
    label { display:block; margin:0.5em 0 0.2em; }
    input { padding:0.6em; width:100%; max-width:320px; box-sizing:border-box; }
    form { margin-bottom:1.5em; }
    #status, #distStatus { white-space:pre-wrap; }
  </style>
</head>
<body>
  <h3>Register Agent</h3>
  <form id="agentForm">
    <label class="required">Property Code</label>
    <input name="propCode" required>
    <label class="required">Agent Name</label>
    <input name="agentName" required>
    <label class="required">Email</label>
    <input name="agentEmail" type="email" required>
    <label class="required">Wallet Address</label>
    <input name="agentWallet" pattern="^0x[a-fA-F0-9]{40}$" required>
    <label class="required">Agent Code</label>
    <input name="agentCode" required>
    <button type="submit">Add Agent</button>
  </form>
  <pre id="status"></pre>

  <h3>Manual Distribution</h3>
  <form id="distForm">
    <label class="required">Property Code</label>
    <input name="distPropCode" required>
    <label class="required">Buyer Wallet</label>
    <input name="buyerWallet" pattern="^0x[a-fA-F0-9]{40}$" required>
    <label class="required">SQMU Amount</label>
    <input name="amount" type="number" min="1" step="0.01" required>
    <label>Agent Code (optional)</label>
    <input name="distAgentCode">
    <button type="submit">Send Tokens</button>
  </form>
  <pre id="distStatus"></pre>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
  <script>
    const CONTRACT_ADDR = '0x05DE67Bcb469dDbddA68534c41fB5CcB7a50Fa7f';
    const AGENT_ABI = ['function setAgentCode(string code, address agent) external'];
    const DIST_ABI = [
      'function distribute(string code, address to, uint256 amount, string agentCode) external',
      'function properties(string) view returns(address token, address treasury)'
    ];
    const TOKEN_ABI = ['function decimals() view returns(uint8)'];
    const PROP_DECIMALS = { SQMU4: 2 };
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx9WwOsCtFOEfWZH7zRK-zvjU0oRzm2Qd8zaF1ABREEWmAlJJ6SnS2HRtnWqiU-0ERv5g/exec';

    async function getDecimals(code) {
      if (PROP_DECIMALS[code]) return PROP_DECIMALS[code];
      const provider = new ethers.JsonRpcProvider('https://polygon-rpc.com');
      const dist = new ethers.Contract(CONTRACT_ADDR, DIST_ABI, provider);
      const info = await dist.properties(code);
      if (!info || info.token === ethers.ZeroAddress) throw new Error('Unknown property');
      const token = new ethers.Contract(info.token, TOKEN_ABI, provider);
      const dec = await token.decimals();
      PROP_DECIMALS[code] = Number(dec);
      return PROP_DECIMALS[code];
    }

    document.getElementById('agentForm').onsubmit = async (e) => {
      e.preventDefault();
      const f = e.target;
      const [name, email, wallet, code, prop] = [
        f.agentName.value.trim(),
        f.agentEmail.value.trim(),
        f.agentWallet.value.trim(),
        f.agentCode.value.trim(),
        f.propCode.value.trim()
      ];
      fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ name, email, wallet, code, prop })
      });
      try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        const signer = await provider.getSigner();
        const dist = new ethers.Contract(CONTRACT_ADDR, AGENT_ABI, signer);
        const tx = await dist.setAgentCode(code, wallet);
        document.getElementById('status').textContent = 'Tx: ' + tx.hash;
        await tx.wait();
        document.getElementById('status').textContent = 'Agent added!';
      } catch (err) {
        document.getElementById('status').textContent = 'Error: ' + err.message;
      }
    };

    document.getElementById('distForm').onsubmit = async (e) => {
      e.preventDefault();
      const f = e.target;
      const [prop, to, amt, code] = [
        f.distPropCode.value.trim(),
        f.buyerWallet.value.trim(),
        f.amount.value.trim(),
        f.distAgentCode.value.trim()
      ];
      try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        const signer = await provider.getSigner();
        const dist = new ethers.Contract(CONTRACT_ADDR, DIST_ABI, signer);
        const dec = await getDecimals(prop);
        const amount = ethers.parseUnits(String(amt), dec);
        const tx = await dist.distribute(prop, to, amount, code);
        document.getElementById('distStatus').textContent = 'Tx: ' + tx.hash;
        await tx.wait();
        document.getElementById('distStatus').textContent = 'Sent ' + amt + ' SQMU';
      } catch (err) {
        document.getElementById('distStatus').textContent = 'Error: ' + err.message;
      }
    };
  </script>
</body>
</html>
