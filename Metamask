<!-- SQMU Crypto Payment Widget â€“ Multi-Wallet (Web3Modal) [FIXED INIT] -->
<div id="crypto-payment-widget" style="max-width:430px;margin:32px auto;padding:20px 18px;border-radius:16px;background:#fff;box-shadow:0 2px 12px #0002;">
  <h3 id="crypto-widget-title" style="margin-bottom:6px;font-size:1.3em;">Pay Consultation Fee</h3>
  <div style="font-size:1.07em;"><span id="display-fee"></span></div>
  <label for="network" style="margin-top:10px;display:block;">Choose Network & Token:</label>
  <select id="network" style="margin:10px 0 12px 0;width:100%;padding:7px;"></select>
  <div id="wallet-ui" style="margin-bottom:12px;">
    <button id="connect-btn" style="width:100%;background:#2865d9;color:#fff;">Connect Wallet</button>
    <div id="user-wallet" style="font-size:0.97em;margin:5px 0;"></div>
    <div id="balances" style="background:#f7f7f7;border-radius:8px;padding:7px 11px;margin:8px 0 6px 0;font-size:0.97em;display:none;"></div>
    <button id="send-btn" style="display:none;width:100%;margin-bottom:10px;background:#08a870;color:#fff;">Send Payment</button>
    <button id="disconnect-btn" style="display:none;width:100%;margin-bottom:10px;background:#e7e7e7;color:#b00;">Disconnect</button>
  </div>
  <div id="qr-ui" style="margin:16px 0;">
    <div><b>Or send manually:</b></div>
    <div>To address: <span id="pay-addr" style="word-break:break-all;"></span></div>
    <button onclick="copyAddr()" style="margin:4px 0 7px 0;">Copy Address</button>
    <div id="qrbox" style="margin-top:7px;"></div>
    <div style="font-size:0.94em;color:#666;">Open your wallet, send exactly <span id="manual-amt"></span> to the address above.</div>
  </div>
  <div id="tx-section" style="margin-top:10px;"></div>
</div>
<style>
#crypto-payment-widget { font-family:sans-serif; }
#crypto-payment-widget input, #crypto-payment-widget select { border-radius:6px;border:1px solid #ccc; }
#crypto-payment-widget button { border-radius:7px; border:none; padding:8px 13px; cursor:pointer; }
#crypto-payment-widget hr { border:0; border-top:1px solid #e5e5e5; }
@media (max-width:500px) { #crypto-payment-widget { padding:12px 3vw; } }
</style>

<!-- DEPENDENCIES from CDN -->
<script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@coinbase/wallet-sdk@3.5.0/dist/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
const DEFAULT_TITLE = "Pay Consultation Fee";
const CONSULT_FEE = 100;
const AED_RATE = 3.67;
const PAYMENT_OPTIONS = [
  {
    key: "usdt-eth",
    label: "Ethereum Mainnet (USDT)",
    chainId: "0x1",
    chainName: "Ethereum",
    token: "USDT",
    tokenAddress: "0xdAC17F958D2ee523a2206206994597C13D831ec7",
    decimals: 6,
    treasury: "0x43F3f03d89290358034993aE3B3938D056D76De2",
    explorer: "https://etherscan.io/tx/"
  },
  {
    key: "usdc-arb",
    label: "Arbitrum One (USDC)",
    chainId: "0xa4b1",
    chainName: "Arbitrum",
    token: "USDC",
    tokenAddress: "0xaf88d065e77c8cC2239327C5EDb3A432268e5831",
    decimals: 6,
    treasury: "0x43F3f03d89290358034993aE3B3938D056D76De2",
    explorer: "https://arbiscan.io/tx/"
  },
  {
    key: "usdc-poly",
    label: "Polygon (USDC)",
    chainId: "0x89",
    chainName: "Polygon",
    token: "USDC",
    tokenAddress: "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359",
    decimals: 6,
    treasury: "0x43F3f03d89290358034993aE3B3938D056D76De2",
    explorer: "https://polygonscan.com/tx/"
  }
];
const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function transfer(address to, uint value) public returns (bool)",
  "function decimals() public view returns (uint8)",
];

// -- Globals
let provider, signer, userAddr, selectedOpt;
let FEE_USD = CONSULT_FEE;
let FEE_AED = Math.round(CONSULT_FEE * AED_RATE);
let PROP_TITLE = DEFAULT_TITLE;

// -- Get params from URL (optional customization)
function getParam(name) {
  try {
    let url = new URL(window.location.href);
    return url.searchParams.get(name) || "";
  } catch(e) { return ""; }
}
function sanitize(s) { return (s || '').replace(/[<>]/g, ''); }
(function initPriceTitleFromURL() {
  let usd = getParam('usd');
  let aed = getParam('aed');
  let title = getParam('title');
  if (usd && !isNaN(Number(usd)) && Number(usd) > 0) FEE_USD = Number(usd);
  if (aed && !isNaN(Number(aed)) && Number(aed) > 0) FEE_AED = Math.round(Number(aed));
  if (title) PROP_TITLE = sanitize(decodeURIComponent(title.replace(/\+/g,' ')));
})();

// -- Populate the dropdown
function populateDropdown() {
  let sel = document.getElementById('network');
  sel.innerHTML = "";
  PAYMENT_OPTIONS.forEach(opt => {
    let o = document.createElement('option');
    o.value = opt.key;
    o.text = opt.label;
    sel.appendChild(o);
  });
}
function getSelectedOpt() {
  let key = document.getElementById('network').value;
  return PAYMENT_OPTIONS.find(o => o.key === key);
}
function updateUI() {
  selectedOpt = getSelectedOpt();
  document.getElementById('crypto-widget-title').innerText = PROP_TITLE;
  document.getElementById('display-fee').innerHTML =
    `${FEE_USD} ${selectedOpt.token} <span style="font-size:0.98em;color:#555">(AED ${FEE_AED})</span>`;
  document.getElementById('pay-addr').innerText = selectedOpt.treasury;
  document.getElementById('manual-amt').innerText = `${FEE_USD} ${selectedOpt.token}`;
  makeQR(selectedOpt.treasury);
  resetWalletUI();
  document.getElementById('tx-section').innerHTML = "";
}
function copyAddr() {
  navigator.clipboard.writeText(selectedOpt.treasury);
  alert("Address copied!");
}
function makeQR(addr) {
  QRCode.toDataURL(addr, { width: 180 }, function (err, url) {
    document.getElementById('qrbox').innerHTML = `<img src="${url}" alt="QR code" style="margin:8px auto 0;display:block;">`;
  });
}
function resetWalletUI() {
  document.getElementById('connect-btn').style.display = '';
  document.getElementById('send-btn').style.display = 'none';
  document.getElementById('disconnect-btn').style.display = 'none';
  document.getElementById('user-wallet').innerText = '';
  document.getElementById('balances').style.display = 'none';
}

// -- Multi-wallet with Web3Modal
let web3Modal;

// -- Initialize UI and event listeners NOW (no DOMContentLoaded needed)
(function widgetInit(){
  populateDropdown();
  updateUI();

  // Provider Options for Web3Modal
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: { infuraId: "822e08935dea4fb48f668ff353ac863a" }
    },
    coinbasewallet: {
      package: window.CoinbaseWalletSDK,
      options: { appName: "SQMU Payment Widget", infuraId: "822e08935dea4fb48f668ff353ac863a" }
    }
    // 'injected' (MetaMask/Trust etc.) is included by default
  };

  web3Modal = new window.Web3Modal.default({
    cacheProvider: false,
    providerOptions
  });

  document.getElementById('connect-btn').onclick = connectWallet;
  document.getElementById('disconnect-btn').onclick = disconnectWallet;
  document.getElementById('send-btn').onclick = sendPayment;
  document.getElementById('network').onchange = updateUI;
})();

async function connectWallet() {
  try {
    const instance = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(instance, "any");
    signer = provider.getSigner();
    userAddr = await signer.getAddress();

    // Switch network if needed
    const net = await provider.getNetwork();
    if ('0x' + net.chainId.toString(16) !== selectedOpt.chainId) {
      try {
        await provider.provider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: selectedOpt.chainId }]
        });
      } catch (e) {
        alert('Please switch to ' + selectedOpt.chainName + ' in your wallet and try again.');
        return;
      }
    }

    document.getElementById('connect-btn').style.display = 'none';
    document.getElementById('disconnect-btn').style.display = '';
    document.getElementById('user-wallet').innerText = `Connected: ${selectedOpt.chainName} ${userAddr.slice(0,7)}...${userAddr.slice(-5)}`;
    document.getElementById('send-btn').style.display = '';
    await showBalances();

    provider.provider.on && provider.provider.on("accountsChanged", () => disconnectWallet());
    provider.provider.on && provider.provider.on("chainChanged", () => disconnectWallet());

  } catch (err) {
    alert("Wallet connection cancelled or failed.");
    resetWalletUI();
  }
}
function disconnectWallet() {
  web3Modal && web3Modal.clearCachedProvider();
  provider = signer = userAddr = null;
  resetWalletUI();
}
async function showBalances() {
  if (!provider || !userAddr) return;
  try {
    const token = new ethers.Contract(selectedOpt.tokenAddress, ERC20_ABI, provider);
    let [tokenBalRaw, tokenDecimals] = await Promise.all([
      token.balanceOf(userAddr),
      token.decimals()
    ]);
    let tokenStr = ethers.utils.formatUnits(tokenBalRaw, tokenDecimals);
    document.getElementById('balances').innerHTML =
      `<b>Your ${selectedOpt.token} Balance:</b> ${tokenStr}`;
    document.getElementById('balances').style.display = '';
  } catch (e) {
    document.getElementById('balances').innerHTML = 'Unable to retrieve balance.';
    document.getElementById('balances').style.display = '';
  }
}
async function sendPayment() {
  if (!signer) return alert('Connect wallet first.');
  const {tokenAddress, treasury, decimals, explorer} = selectedOpt;
  const amt = FEE_USD;
  let contract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
  try {
    document.getElementById('send-btn').innerText = 'Awaiting confirmation...';
    document.getElementById('send-btn').disabled = true;
    let tx = await contract.transfer(treasury, ethers.utils.parseUnits(amt.toString(), decimals));
    await tx.wait(); // Confirm mined
    document.getElementById('send-btn').innerText = 'Send Payment';
    document.getElementById('send-btn').disabled = false;
    showTxResult(tx.hash);
    await showBalances();
  } catch (e) {
    document.getElementById('send-btn').innerText = 'Send Payment';
    document.getElementById('send-btn').disabled = false;
    let msg = (e && e.message) ? e.message : 'Transaction cancelled, declined, or insufficient funds.';
    alert('Payment failed: ' + msg);
  }
}
function showTxResult(hash) {
  let url = selectedOpt.explorer + hash;
  document.getElementById('tx-section').innerHTML =
    `<div style="background:#eaffea;border-radius:8px;padding:10px 11px;">
      <b>Payment sent!</b><br>
      Tx hash: <a href="${url}" target="_blank">${hash}</a>
      <br>Thank you for your payment.
    </div>`;
}
</script>
